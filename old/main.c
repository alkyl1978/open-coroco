#define F_CPU 10000000UL
#include <avr/io.h>
#include <util/delay.h>
#include <stdio.h>
#include "UART.h"
#include "Hardware.h"
#include "Timer.h"
#include <avr/interrupt.h>
#include <avr/pgmspace.h>
#include <math.h>

#define sinTableSize  3600
PROGMEM prog_int16_t sin_table[sinTableSize]= { 0 , 0 , 1 , 2 , 3 , 4 , 5 , 6 , 7 , 8 , 8 , 9 , 10 , 11 , 12 , 13 , 14 , 15 , 16 , 16 , 17 , 18 , 19 , 20 , 21 , 22 , 23 , 24 , 24 , 25 , 26 , 27 , 28 , 29 , 30 , 31 , 32 , 32 , 33 , 34 , 35 , 36 , 37 , 38 , 39 , 40 , 40 , 41 , 42 , 43 , 44 , 45 , 46 , 47 , 48 , 48 , 49 , 50 , 51 , 52 , 53 , 54 , 55 , 56 , 56 , 57 , 58 , 59 , 60 , 61 , 62 , 63 , 64 , 64 , 65 , 66 , 67 , 68 , 69 , 70 , 71 , 72 , 72 , 73 , 74 , 75 , 76 , 77 , 78 , 79 , 79 , 80 , 81 , 82 , 83 , 84 , 85 , 86 , 86 , 87 , 88 , 89 , 90 , 91 , 92 , 93 , 93 , 94 , 95 , 96 , 97 , 98 , 99 , 100 , 101 , 101 , 102 , 103 , 104 , 105 , 106 , 107 , 107 , 108 , 109 , 110 , 111 , 112 , 113 , 114 , 114 , 115 , 116 , 117 , 118 , 119 , 120 , 121 , 121 , 122 , 123 , 124 , 125 , 126 , 127 , 127 , 128 , 129 , 130 , 131 , 132 , 133 , 133 , 134 , 135 , 136 , 137 , 138 , 139 , 139 , 140 , 141 , 142 , 143 , 144 , 145 , 145 , 146 , 147 , 148 , 149 , 150 , 151 , 151 , 152 , 153 , 154 , 155 , 156 , 157 , 157 , 158 , 159 , 160 , 161 , 162 , 162 , 163 , 164 , 165 , 166 , 167 , 168 , 168 , 169 , 170 , 171 , 172 , 173 , 173 , 174 , 175 , 176 , 177 , 178 , 178 , 179 , 180 , 181 , 182 , 183 , 183 , 184 , 185 , 186 , 187 , 188 , 188 , 189 , 190 , 191 , 192 , 193 , 193 , 194 , 195 , 196 , 197 , 198 , 198 , 199 , 200 , 201 , 202 , 202 , 203 , 204 , 205 , 206 , 207 , 207 , 208 , 209 , 210 , 211 , 211 , 212 , 213 , 214 , 215 , 215 , 216 , 217 , 218 , 219 , 219 , 220 , 221 , 222 , 223 , 224 , 224 , 225 , 226 , 227 , 228 , 228 , 229 , 230 , 231 , 231 , 232 , 233 , 234 , 235 , 235 , 236 , 237 , 238 , 239 , 239 , 240 , 241 , 242 , 243 , 243 , 244 , 245 , 246 , 246 , 247 , 248 , 249 , 250 , 250 , 251 , 252 , 253 , 253 , 254 , 255 , 256 , 257 , 257 , 258 , 259 , 260 , 260 , 261 , 262 , 263 , 263 , 264 , 265 , 266 , 266 , 267 , 268 , 269 , 270 , 270 , 271 , 272 , 273 , 273 , 274 , 275 , 276 , 276 , 277 , 278 , 279 , 279 , 280 , 281 , 282 , 282 , 283 , 284 , 285 , 285 , 286 , 287 , 287 , 288 , 289 , 290 , 290 , 291 , 292 , 293 , 293 , 294 , 295 , 296 , 296 , 297 , 298 , 298 , 299 , 300 , 301 , 301 , 302 , 303 , 303 , 304 , 305 , 306 , 306 , 307 , 308 , 308 , 309 , 310 , 311 , 311 , 312 , 313 , 313 , 314 , 315 , 316 , 316 , 317 , 318 , 318 , 319 , 320 , 320 , 321 , 322 , 322 , 323 , 324 , 325 , 325 , 326 , 327 , 327 , 328 , 329 , 329 , 330 , 331 , 331 , 332 , 333 , 333 , 334 , 335 , 335 , 336 , 337 , 337 , 338 , 339 , 339 , 340 , 341 , 341 , 342 , 343 , 343 , 344 , 345 , 345 , 346 , 347 , 347 , 348 , 349 , 349 , 350 , 351 , 351 , 352 , 353 , 353 , 354 , 354 , 355 , 356 , 356 , 357 , 358 , 358 , 359 , 360 , 360 , 361 , 361 , 362 , 363 , 363 , 364 , 365 , 365 , 366 , 366 , 367 , 368 , 368 , 369 , 370 , 370 , 371 , 371 , 372 , 373 , 373 , 374 , 374 , 375 , 376 , 376 , 377 , 377 , 378 , 379 , 379 , 380 , 380 , 381 , 382 , 382 , 383 , 383 , 384 , 385 , 385 , 386 , 386 , 387 , 387 , 388 , 389 , 389 , 390 , 390 , 391 , 392 , 392 , 393 , 393 , 394 , 394 , 395 , 395 , 396 , 397 , 397 , 398 , 398 , 399 , 399 , 400 , 401 , 401 , 402 , 402 , 403 , 403 , 404 , 404 , 405 , 405 , 406 , 407 , 407 , 408 , 408 , 409 , 409 , 410 , 410 , 411 , 411 , 412 , 412 , 413 , 413 , 414 , 414 , 415 , 416 , 416 , 417 , 417 , 418 , 418 , 419 , 419 , 420 , 420 , 421 , 421 , 422 , 422 , 423 , 423 , 424 , 424 , 425 , 425 , 426 , 426 , 427 , 427 , 428 , 428 , 429 , 429 , 430 , 430 , 430 , 431 , 431 , 432 , 432 , 433 , 433 , 434 , 434 , 435 , 435 , 436 , 436 , 437 , 437 , 438 , 438 , 438 , 439 , 439 , 440 , 440 , 441 , 441 , 442 , 442 , 442 , 443 , 443 , 444 , 444 , 445 , 445 , 446 , 446 , 446 , 447 , 447 , 448 , 448 , 449 , 449 , 449 , 450 , 450 , 451 , 451 , 452 , 452 , 452 , 453 , 453 , 454 , 454 , 454 , 455 , 455 , 456 , 456 , 456 , 457 , 457 , 458 , 458 , 458 , 459 , 459 , 460 , 460 , 460 , 461 , 461 , 461 , 462 , 462 , 463 , 463 , 463 , 464 , 464 , 464 , 465 , 465 , 466 , 466 , 466 , 467 , 467 , 467 , 468 , 468 , 468 , 469 , 469 , 470 , 470 , 470 , 471 , 471 , 471 , 472 , 472 , 472 , 473 , 473 , 473 , 474 , 474 , 474 , 475 , 475 , 475 , 476 , 476 , 476 , 477 , 477 , 477 , 478 , 478 , 478 , 478 , 479 , 479 , 479 , 480 , 480 , 480 , 481 , 481 , 481 , 481 , 482 , 482 , 482 , 483 , 483 , 483 , 484 , 484 , 484 , 484 , 485 , 485 , 485 , 485 , 486 , 486 , 486 , 487 , 487 , 487 , 487 , 488 , 488 , 488 , 488 , 489 , 489 , 489 , 489 , 490 , 490 , 490 , 490 , 491 , 491 , 491 , 491 , 492 , 492 , 492 , 492 , 493 , 493 , 493 , 493 , 494 , 494 , 494 , 494 , 494 , 495 , 495 , 495 , 495 , 496 , 496 , 496 , 496 , 496 , 497 , 497 , 497 , 497 , 497 , 498 , 498 , 498 , 498 , 498 , 499 , 499 , 499 , 499 , 499 , 500 , 500 , 500 , 500 , 500 , 500 , 501 , 501 , 501 , 501 , 501 , 501 , 502 , 502 , 502 , 502 , 502 , 502 , 503 , 503 , 503 , 503 , 503 , 503 , 503 , 504 , 504 , 504 , 504 , 504 , 504 , 504 , 505 , 505 , 505 , 505 , 505 , 505 , 505 , 506 , 506 , 506 , 506 , 506 , 506 , 506 , 506 , 506 , 507 , 507 , 507 , 507 , 507 , 507 , 507 , 507 , 507 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 510 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 509 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 508 , 507 , 507 , 507 , 507 , 507 , 507 , 507 , 507 , 507 , 506 , 506 , 506 , 506 , 506 , 506 , 506 , 506 , 506 , 505 , 505 , 505 , 505 , 505 , 505 , 505 , 504 , 504 , 504 , 504 , 504 , 504 , 504 , 503 , 503 , 503 , 503 , 503 , 503 , 503 , 502 , 502 , 502 , 502 , 502 , 502 , 501 , 501 , 501 , 501 , 501 , 501 , 500 , 500 , 500 , 500 , 500 , 500 , 499 , 499 , 499 , 499 , 499 , 498 , 498 , 498 , 498 , 498 , 497 , 497 , 497 , 497 , 497 , 496 , 496 , 496 , 496 , 496 , 495 , 495 , 495 , 495 , 494 , 494 , 494 , 494 , 494 , 493 , 493 , 493 , 493 , 492 , 492 , 492 , 492 , 491 , 491 , 491 , 491 , 490 , 490 , 490 , 490 , 489 , 489 , 489 , 489 , 488 , 488 , 488 , 488 , 487 , 487 , 487 , 487 , 486 , 486 , 486 , 485 , 485 , 485 , 485 , 484 , 484 , 484 , 484 , 483 , 483 , 483 , 482 , 482 , 482 , 481 , 481 , 481 , 481 , 480 , 480 , 480 , 479 , 479 , 479 , 478 , 478 , 478 , 478 , 477 , 477 , 477 , 476 , 476 , 476 , 475 , 475 , 475 , 474 , 474 , 474 , 473 , 473 , 473 , 472 , 472 , 472 , 471 , 471 , 471 , 470 , 470 , 470 , 469 , 469 , 468 , 468 , 468 , 467 , 467 , 467 , 466 , 466 , 466 , 465 , 465 , 464 , 464 , 464 , 463 , 463 , 463 , 462 , 462 , 461 , 461 , 461 , 460 , 460 , 460 , 459 , 459 , 458 , 458 , 458 , 457 , 457 , 456 , 456 , 456 , 455 , 455 , 454 , 454 , 454 , 453 , 453 , 452 , 452 , 452 , 451 , 451 , 450 , 450 , 449 , 449 , 449 , 448 , 448 , 447 , 447 , 446 , 446 , 446 , 445 , 445 , 444 , 444 , 443 , 443 , 442 , 442 , 442 , 441 , 441 , 440 , 440 , 439 , 439 , 438 , 438 , 438 , 437 , 437 , 436 , 436 , 435 , 435 , 434 , 434 , 433 , 433 , 432 , 432 , 431 , 431 , 430 , 430 , 430 , 429 , 429 , 428 , 428 , 427 , 427 , 426 , 426 , 425 , 425 , 424 , 424 , 423 , 423 , 422 , 422 , 421 , 421 , 420 , 420 , 419 , 419 , 418 , 418 , 417 , 417 , 416 , 416 , 415 , 414 , 414 , 413 , 413 , 412 , 412 , 411 , 411 , 410 , 410 , 409 , 409 , 408 , 408 , 407 , 407 , 406 , 405 , 405 , 404 , 404 , 403 , 403 , 402 , 402 , 401 , 401 , 400 , 399 , 399 , 398 , 398 , 397 , 397 , 396 , 395 , 395 , 394 , 394 , 393 , 393 , 392 , 392 , 391 , 390 , 390 , 389 , 389 , 388 , 387 , 387 , 386 , 386 , 385 , 385 , 384 , 383 , 383 , 382 , 382 , 381 , 380 , 380 , 379 , 379 , 378 , 377 , 377 , 376 , 376 , 375 , 374 , 374 , 373 , 373 , 372 , 371 , 371 , 370 , 370 , 369 , 368 , 368 , 367 , 366 , 366 , 365 , 365 , 364 , 363 , 363 , 362 , 361 , 361 , 360 , 360 , 359 , 358 , 358 , 357 , 356 , 356 , 355 , 354 , 354 , 353 , 353 , 352 , 351 , 351 , 350 , 349 , 349 , 348 , 347 , 347 , 346 , 345 , 345 , 344 , 343 , 343 , 342 , 341 , 341 , 340 , 339 , 339 , 338 , 337 , 337 , 336 , 335 , 335 , 334 , 333 , 333 , 332 , 331 , 331 , 330 , 329 , 329 , 328 , 327 , 327 , 326 , 325 , 325 , 324 , 323 , 322 , 322 , 321 , 320 , 320 , 319 , 318 , 318 , 317 , 316 , 316 , 315 , 314 , 313 , 313 , 312 , 311 , 311 , 310 , 309 , 308 , 308 , 307 , 306 , 306 , 305 , 304 , 303 , 303 , 302 , 301 , 301 , 300 , 299 , 298 , 298 , 297 , 296 , 296 , 295 , 294 , 293 , 293 , 292 , 291 , 290 , 290 , 289 , 288 , 287 , 287 , 286 , 285 , 285 , 284 , 283 , 282 , 282 , 281 , 280 , 279 , 279 , 278 , 277 , 276 , 276 , 275 , 274 , 273 , 273 , 272 , 271 , 270 , 270 , 269 , 268 , 267 , 266 , 266 , 265 , 264 , 263 , 263 , 262 , 261 , 260 , 260 , 259 , 258 , 257 , 257 , 256 , 255 , 254 , 253 , 253 , 252 , 251 , 250 , 250 , 249 , 248 , 247 , 246 , 246 , 245 , 244 , 243 , 243 , 242 , 241 , 240 , 239 , 239 , 238 , 237 , 236 , 235 , 235 , 234 , 233 , 232 , 231 , 231 , 230 , 229 , 228 , 228 , 227 , 226 , 225 , 224 , 224 , 223 , 222 , 221 , 220 , 219 , 219 , 218 , 217 , 216 , 215 , 215 , 214 , 213 , 212 , 211 , 211 , 210 , 209 , 208 , 207 , 207 , 206 , 205 , 204 , 203 , 202 , 202 , 201 , 200 , 199 , 198 , 198 , 197 , 196 , 195 , 194 , 193 , 193 , 192 , 191 , 190 , 189 , 188 , 188 , 187 , 186 , 185 , 184 , 183 , 183 , 182 , 181 , 180 , 179 , 178 , 178 , 177 , 176 , 175 , 174 , 173 , 173 , 172 , 171 , 170 , 169 , 168 , 168 , 167 , 166 , 165 , 164 , 163 , 162 , 162 , 161 , 160 , 159 , 158 , 157 , 157 , 156 , 155 , 154 , 153 , 152 , 151 , 151 , 150 , 149 , 148 , 147 , 146 , 145 , 145 , 144 , 143 , 142 , 141 , 140 , 139 , 139 , 138 , 137 , 136 , 135 , 134 , 133 , 133 , 132 , 131 , 130 , 129 , 128 , 127 , 127 , 126 , 125 , 124 , 123 , 122 , 121 , 121 , 120 , 119 , 118 , 117 , 116 , 115 , 114 , 114 , 113 , 112 , 111 , 110 , 109 , 108 , 107 , 107 , 106 , 105 , 104 , 103 , 102 , 101 , 100 , 100 , 99 , 98 , 97 , 96 , 95 , 94 , 93 , 93 , 92 , 91 , 90 , 89 , 88 , 87 , 86 , 86 , 85 , 84 , 83 , 82 , 81 , 80 , 79 , 79 , 78 , 77 , 76 , 75 , 74 , 73 , 72 , 71 , 71 , 70 , 69 , 68 , 67 , 66 , 65 , 64 , 64 , 63 , 62 , 61 , 60 , 59 , 58 , 57 , 56 , 56 , 55 , 54 , 53 , 52 , 51 , 50 , 49 , 48 , 48 , 47 , 46 , 45 , 44 , 43 , 42 , 41 , 40 , 40 , 39 , 38 , 37 , 36 , 35 , 34 , 33 , 32 , 32 , 31 , 30 , 29 , 28 , 27 , 26 , 25 , 24 , 24 , 23 , 22 , 21 , 20 , 19 , 18 , 17 , 16 , 16 , 15 , 14 , 13 , 12 , 11 , 10 , 9 , 8 , 8 , 7 , 6 , 5 , 4 , 3 , 2 , 1 , 0 , 0 , 0 , -1 , -2 , -3 , -4 , -5 , -6 , -7 , -8 , -8 , -9 , -10 , -11 , -12 , -13 , -14 , -15 , -16 , -16 , -17 , -18 , -19 , -20 , -21 , -22 , -23 , -24 , -24 , -25 , -26 , -27 , -28 , -29 , -30 , -31 , -32 , -32 , -33 , -34 , -35 , -36 , -37 , -38 , -39 , -40 , -40 , -41 , -42 , -43 , -44 , -45 , -46 , -47 , -48 , -48 , -49 , -50 , -51 , -52 , -53 , -54 , -55 , -56 , -56 , -57 , -58 , -59 , -60 , -61 , -62 , -63 , -64 , -64 , -65 , -66 , -67 , -68 , -69 , -70 , -71 , -72 , -72 , -73 , -74 , -75 , -76 , -77 , -78 , -79 , -79 , -80 , -81 , -82 , -83 , -84 , -85 , -86 , -86 , -87 , -88 , -89 , -90 , -91 , -92 , -93 , -94 , -94 , -95 , -96 , -97 , -98 , -99 , -100 , -101 , -101 , -102 , -103 , -104 , -105 , -106 , -107 , -107 , -108 , -109 , -110 , -111 , -112 , -113 , -114 , -114 , -115 , -116 , -117 , -118 , -119 , -120 , -121 , -121 , -122 , -123 , -124 , -125 , -126 , -127 , -127 , -128 , -129 , -130 , -131 , -132 , -133 , -133 , -134 , -135 , -136 , -137 , -138 , -139 , -139 , -140 , -141 , -142 , -143 , -144 , -145 , -145 , -146 , -147 , -148 , -149 , -150 , -151 , -151 , -152 , -153 , -154 , -155 , -156 , -157 , -157 , -158 , -159 , -160 , -161 , -162 , -162 , -163 , -164 , -165 , -166 , -167 , -168 , -168 , -169 , -170 , -171 , -172 , -173 , -173 , -174 , -175 , -176 , -177 , -178 , -178 , -179 , -180 , -181 , -182 , -183 , -183 , -184 , -185 , -186 , -187 , -188 , -188 , -189 , -190 , -191 , -192 , -193 , -193 , -194 , -195 , -196 , -197 , -198 , -198 , -199 , -200 , -201 , -202 , -202 , -203 , -204 , -205 , -206 , -207 , -207 , -208 , -209 , -210 , -211 , -211 , -212 , -213 , -214 , -215 , -215 , -216 , -217 , -218 , -219 , -219 , -220 , -221 , -222 , -223 , -224 , -224 , -225 , -226 , -227 , -228 , -228 , -229 , -230 , -231 , -231 , -232 , -233 , -234 , -235 , -235 , -236 , -237 , -238 , -239 , -239 , -240 , -241 , -242 , -243 , -243 , -244 , -245 , -246 , -246 , -247 , -248 , -249 , -250 , -250 , -251 , -252 , -253 , -253 , -254 , -255 , -256 , -257 , -257 , -258 , -259 , -260 , -260 , -261 , -262 , -263 , -263 , -264 , -265 , -266 , -267 , -267 , -268 , -269 , -270 , -270 , -271 , -272 , -273 , -273 , -274 , -275 , -276 , -276 , -277 , -278 , -279 , -279 , -280 , -281 , -282 , -282 , -283 , -284 , -285 , -285 , -286 , -287 , -287 , -288 , -289 , -290 , -290 , -291 , -292 , -293 , -293 , -294 , -295 , -296 , -296 , -297 , -298 , -298 , -299 , -300 , -301 , -301 , -302 , -303 , -303 , -304 , -305 , -306 , -306 , -307 , -308 , -308 , -309 , -310 , -311 , -311 , -312 , -313 , -313 , -314 , -315 , -316 , -316 , -317 , -318 , -318 , -319 , -320 , -320 , -321 , -322 , -322 , -323 , -324 , -325 , -325 , -326 , -327 , -327 , -328 , -329 , -329 , -330 , -331 , -331 , -332 , -333 , -333 , -334 , -335 , -335 , -336 , -337 , -337 , -338 , -339 , -339 , -340 , -341 , -341 , -342 , -343 , -343 , -344 , -345 , -345 , -346 , -347 , -347 , -348 , -349 , -349 , -350 , -351 , -351 , -352 , -353 , -353 , -354 , -354 , -355 , -356 , -356 , -357 , -358 , -358 , -359 , -360 , -360 , -361 , -361 , -362 , -363 , -363 , -364 , -365 , -365 , -366 , -366 , -367 , -368 , -368 , -369 , -370 , -370 , -371 , -371 , -372 , -373 , -373 , -374 , -374 , -375 , -376 , -376 , -377 , -377 , -378 , -379 , -379 , -380 , -380 , -381 , -382 , -382 , -383 , -383 , -384 , -385 , -385 , -386 , -386 , -387 , -387 , -388 , -389 , -389 , -390 , -390 , -391 , -392 , -392 , -393 , -393 , -394 , -394 , -395 , -395 , -396 , -397 , -397 , -398 , -398 , -399 , -399 , -400 , -401 , -401 , -402 , -402 , -403 , -403 , -404 , -404 , -405 , -405 , -406 , -407 , -407 , -408 , -408 , -409 , -409 , -410 , -410 , -411 , -411 , -412 , -412 , -413 , -413 , -414 , -414 , -415 , -416 , -416 , -417 , -417 , -418 , -418 , -419 , -419 , -420 , -420 , -421 , -421 , -422 , -422 , -423 , -423 , -424 , -424 , -425 , -425 , -426 , -426 , -427 , -427 , -428 , -428 , -429 , -429 , -430 , -430 , -430 , -431 , -431 , -432 , -432 , -433 , -433 , -434 , -434 , -435 , -435 , -436 , -436 , -437 , -437 , -438 , -438 , -438 , -439 , -439 , -440 , -440 , -441 , -441 , -442 , -442 , -442 , -443 , -443 , -444 , -444 , -445 , -445 , -446 , -446 , -446 , -447 , -447 , -448 , -448 , -449 , -449 , -449 , -450 , -450 , -451 , -451 , -452 , -452 , -452 , -453 , -453 , -454 , -454 , -454 , -455 , -455 , -456 , -456 , -456 , -457 , -457 , -458 , -458 , -458 , -459 , -459 , -460 , -460 , -460 , -461 , -461 , -461 , -462 , -462 , -463 , -463 , -463 , -464 , -464 , -464 , -465 , -465 , -466 , -466 , -466 , -467 , -467 , -467 , -468 , -468 , -468 , -469 , -469 , -470 , -470 , -470 , -471 , -471 , -471 , -472 , -472 , -472 , -473 , -473 , -473 , -474 , -474 , -474 , -475 , -475 , -475 , -476 , -476 , -476 , -477 , -477 , -477 , -478 , -478 , -478 , -478 , -479 , -479 , -479 , -480 , -480 , -480 , -481 , -481 , -481 , -481 , -482 , -482 , -482 , -483 , -483 , -483 , -484 , -484 , -484 , -484 , -485 , -485 , -485 , -485 , -486 , -486 , -486 , -487 , -487 , -487 , -487 , -488 , -488 , -488 , -488 , -489 , -489 , -489 , -489 , -490 , -490 , -490 , -490 , -491 , -491 , -491 , -491 , -492 , -492 , -492 , -492 , -493 , -493 , -493 , -493 , -494 , -494 , -494 , -494 , -494 , -495 , -495 , -495 , -495 , -496 , -496 , -496 , -496 , -496 , -497 , -497 , -497 , -497 , -497 , -498 , -498 , -498 , -498 , -498 , -499 , -499 , -499 , -499 , -499 , -500 , -500 , -500 , -500 , -500 , -500 , -501 , -501 , -501 , -501 , -501 , -501 , -502 , -502 , -502 , -502 , -502 , -502 , -503 , -503 , -503 , -503 , -503 , -503 , -503 , -504 , -504 , -504 , -504 , -504 , -504 , -504 , -505 , -505 , -505 , -505 , -505 , -505 , -505 , -506 , -506 , -506 , -506 , -506 , -506 , -506 , -506 , -506 , -507 , -507 , -507 , -507 , -507 , -507 , -507 , -507 , -507 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -510 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -509 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -508 , -507 , -507 , -507 , -507 , -507 , -507 , -507 , -507 , -507 , -506 , -506 , -506 , -506 , -506 , -506 , -506 , -506 , -506 , -505 , -505 , -505 , -505 , -505 , -505 , -505 , -504 , -504 , -504 , -504 , -504 , -504 , -504 , -503 , -503 , -503 , -503 , -503 , -503 , -503 , -502 , -502 , -502 , -502 , -502 , -502 , -501 , -501 , -501 , -501 , -501 , -501 , -500 , -500 , -500 , -500 , -500 , -500 , -499 , -499 , -499 , -499 , -499 , -498 , -498 , -498 , -498 , -498 , -497 , -497 , -497 , -497 , -497 , -496 , -496 , -496 , -496 , -496 , -495 , -495 , -495 , -495 , -494 , -494 , -494 , -494 , -494 , -493 , -493 , -493 , -493 , -492 , -492 , -492 , -492 , -491 , -491 , -491 , -491 , -490 , -490 , -490 , -490 , -489 , -489 , -489 , -489 , -488 , -488 , -488 , -488 , -487 , -487 , -487 , -487 , -486 , -486 , -486 , -485 , -485 , -485 , -485 , -484 , -484 , -484 , -484 , -483 , -483 , -483 , -482 , -482 , -482 , -481 , -481 , -481 , -481 , -480 , -480 , -480 , -479 , -479 , -479 , -478 , -478 , -478 , -478 , -477 , -477 , -477 , -476 , -476 , -476 , -475 , -475 , -475 , -474 , -474 , -474 , -473 , -473 , -473 , -472 , -472 , -472 , -471 , -471 , -471 , -470 , -470 , -470 , -469 , -469 , -468 , -468 , -468 , -467 , -467 , -467 , -466 , -466 , -466 , -465 , -465 , -464 , -464 , -464 , -463 , -463 , -463 , -462 , -462 , -461 , -461 , -461 , -460 , -460 , -460 , -459 , -459 , -458 , -458 , -458 , -457 , -457 , -456 , -456 , -456 , -455 , -455 , -454 , -454 , -454 , -453 , -453 , -452 , -452 , -452 , -451 , -451 , -450 , -450 , -449 , -449 , -449 , -448 , -448 , -447 , -447 , -446 , -446 , -446 , -445 , -445 , -444 , -444 , -443 , -443 , -442 , -442 , -442 , -441 , -441 , -440 , -440 , -439 , -439 , -438 , -438 , -438 , -437 , -437 , -436 , -436 , -435 , -435 , -434 , -434 , -433 , -433 , -432 , -432 , -431 , -431 , -430 , -430 , -430 , -429 , -429 , -428 , -428 , -427 , -427 , -426 , -426 , -425 , -425 , -424 , -424 , -423 , -423 , -422 , -422 , -421 , -421 , -420 , -420 , -419 , -419 , -418 , -418 , -417 , -417 , -416 , -416 , -415 , -414 , -414 , -413 , -413 , -412 , -412 , -411 , -411 , -410 , -410 , -409 , -409 , -408 , -408 , -407 , -407 , -406 , -405 , -405 , -404 , -404 , -403 , -403 , -402 , -402 , -401 , -401 , -400 , -399 , -399 , -398 , -398 , -397 , -397 , -396 , -395 , -395 , -394 , -394 , -393 , -393 , -392 , -392 , -391 , -390 , -390 , -389 , -389 , -388 , -387 , -387 , -386 , -386 , -385 , -385 , -384 , -383 , -383 , -382 , -382 , -381 , -380 , -380 , -379 , -379 , -378 , -377 , -377 , -376 , -376 , -375 , -374 , -374 , -373 , -373 , -372 , -371 , -371 , -370 , -370 , -369 , -368 , -368 , -367 , -366 , -366 , -365 , -365 , -364 , -363 , -363 , -362 , -361 , -361 , -360 , -360 , -359 , -358 , -358 , -357 , -356 , -356 , -355 , -354 , -354 , -353 , -353 , -352 , -351 , -351 , -350 , -349 , -349 , -348 , -347 , -347 , -346 , -345 , -345 , -344 , -343 , -343 , -342 , -341 , -341 , -340 , -339 , -339 , -338 , -337 , -337 , -336 , -335 , -335 , -334 , -333 , -333 , -332 , -331 , -331 , -330 , -329 , -329 , -328 , -327 , -327 , -326 , -325 , -325 , -324 , -323 , -322 , -322 , -321 , -320 , -320 , -319 , -318 , -318 , -317 , -316 , -316 , -315 , -314 , -313 , -313 , -312 , -311 , -311 , -310 , -309 , -308 , -308 , -307 , -306 , -306 , -305 , -304 , -303 , -303 , -302 , -301 , -301 , -300 , -299 , -298 , -298 , -297 , -296 , -296 , -295 , -294 , -293 , -293 , -292 , -291 , -290 , -290 , -289 , -288 , -287 , -287 , -286 , -285 , -285 , -284 , -283 , -282 , -282 , -281 , -280 , -279 , -279 , -278 , -277 , -276 , -276 , -275 , -274 , -273 , -273 , -272 , -271 , -270 , -270 , -269 , -268 , -267 , -266 , -266 , -265 , -264 , -263 , -263 , -262 , -261 , -260 , -260 , -259 , -258 , -257 , -257 , -256 , -255 , -254 , -253 , -253 , -252 , -251 , -250 , -250 , -249 , -248 , -247 , -246 , -246 , -245 , -244 , -243 , -243 , -242 , -241 , -240 , -239 , -239 , -238 , -237 , -236 , -235 , -235 , -234 , -233 , -232 , -231 , -231 , -230 , -229 , -228 , -228 , -227 , -226 , -225 , -224 , -224 , -223 , -222 , -221 , -220 , -219 , -219 , -218 , -217 , -216 , -215 , -215 , -214 , -213 , -212 , -211 , -211 , -210 , -209 , -208 , -207 , -207 , -206 , -205 , -204 , -203 , -202 , -202 , -201 , -200 , -199 , -198 , -198 , -197 , -196 , -195 , -194 , -193 , -193 , -192 , -191 , -190 , -189 , -188 , -188 , -187 , -186 , -185 , -184 , -183 , -183 , -182 , -181 , -180 , -179 , -178 , -178 , -177 , -176 , -175 , -174 , -173 , -173 , -172 , -171 , -170 , -169 , -168 , -168 , -167 , -166 , -165 , -164 , -163 , -162 , -162 , -161 , -160 , -159 , -158 , -157 , -157 , -156 , -155 , -154 , -153 , -152 , -151 , -151 , -150 , -149 , -148 , -147 , -146 , -145 , -145 , -144 , -143 , -142 , -141 , -140 , -139 , -139 , -138 , -137 , -136 , -135 , -134 , -133 , -133 , -132 , -131 , -130 , -129 , -128 , -127 , -127 , -126 , -125 , -124 , -123 , -122 , -121 , -121 , -120 , -119 , -118 , -117 , -116 , -115 , -114 , -114 , -113 , -112 , -111 , -110 , -109 , -108 , -107 , -107 , -106 , -105 , -104 , -103 , -102 , -101 , -100 , -100 , -99 , -98 , -97 , -96 , -95 , -94 , -93 , -93 , -92 , -91 , -90 , -89 , -88 , -87 , -86 , -86 , -85 , -84 , -83 , -82 , -81 , -80 , -79 , -79 , -78 , -77 , -76 , -75 , -74 , -73 , -72 , -71 , -71 , -70 , -69 , -68 , -67 , -66 , -65 , -64 , -64 , -63 , -62 , -61 , -60 , -59 , -58 , -57 , -56 , -56 , -55 , -54 , -53 , -52 , -51 , -50 , -49 , -48 , -48 , -47 , -46 , -45 , -44 , -43 , -42 , -41 , -40 , -40 , -39 , -38 , -37 , -36 , -35 , -34 , -33 , -32 , -32 , -31 , -30 , -29 , -28 , -27 , -26 , -25 , -24 , -24 , -23 , -22 , -21 , -20 , -19 , -18 , -17 , -16 , -16 , -15 , -14 , -13 , -12 , -11 , -10 , -9 , -8 , -8 , -7 , -6 , -5 , -4 , -3 , -2 , -1 , 0 };
//PROGMEM prog_int16_t prueba[2]={0x10,0x11};

#define PORTC_ON( pin )		PORTC|= (1 << pin );
#define PORTC_OFF( pin )    	PORTC&= (~(1 << pin )); 

#define maxValPWM 0x1ff
//#define maxValPWM 0x0ff
//#define Kv 900 //motor sky
#define Kv 62.5
//#define Kv 416
//#define maxFreq 570 //motor sky
#define maxFreq 39.68
//#define maxFreq 50
//#define P 0.1
#define Tc 0.000064*2
//#define Tc 0.000064*4
//#define maxFreq 264
//This speed is for 12.7Volts: Formula: Poles*Kv*V/60. Poles=3, Kv=900
#define phaseConst 40
#define closeInitFreq 80
#define closeFinalFreq 30
#define fspinError 4
#define TimerResFactor 1
#define maxPhaseAdvance 90*phaseConst
#define maxA maxPhaseAdvance/72
int T=20000;
int dT=50;
int closeLoop=0;
int phaseRotor=0;
int phaseStator=0;
int phaseAdvance=0;
int Terror=0;
int phaseSum=0;
int phaseStatorPointerA=340;
int phaseStatorPointerB=340-120;
int phaseStatorPointerC=340-240;;
double freq=0;
double phase=0; //in rads
int A=0;
int dutyA;
int dutyB;
int dutyC;

ISR(TIMER2_COMP_vect) {
  //We enter this routine with a frequency of 3968Hz
  //One count is 0.000252s
  static int dutyAT=0;
  static int dutyBT=0;
  static int dutyCT=0;
  static int time=-1;
  static int Ttemp=0;
  time+=1;
  PORTC_ON( PINC0 )
  PORTC_ON( PINC1 )
  
  //Dealing with slow rotor problem
  Ttemp+=1;
  if ((Ttemp*2>T) && closeLoop) { //if no more readings from the halls sensors then update T
    T=Ttemp*2;
  }

  //Rotor and Stator phase calculations
  phaseStator=phaseStator+360*phaseConst/T;
  phaseRotor=phaseRotor+360*phaseConst/T;

  PORTC_OFF( PINC1 )

  //code for hall sensoring
  static int hall1Rise=0;
  static int hall1Old=-20000;
  static int hall1tOld=-30000; //To produce a small initial frequency
  int hall1;
  int hallUpdate=0;
  static int hallUpdateRise=0;
  static int hallUpdateFall=0;
  hall1=(int) ADC;
  if (hall1 > hall1Old) {
    hall1Rise=1;
  } 
  if (hall1 < hall1Old) {
    hall1Rise=0;
  }
  if ((hall1Rise==1) && (hall1>0) && (hallUpdateRise==0)) {
    PORTC_ON( PINC2 )
    //zero crossing rising
    //Fix phase to zero
    //Calculate new frequency
    if (closeLoop==1) {
      T=(time-hall1tOld)*2; //Half a cycle
    }
    hall1tOld=time;
    phaseRotor=0;
    hallUpdate=1;
    hallUpdateRise=1;
    hallUpdateFall=0;
    //PORTC_OFF( PINC2 )
  }
  if ((hall1Rise==0) && (hall1<0) && (hallUpdateFall==0)) {
    //PORTC_ON( PINC2 )
    //zero crossing falling
    //Fix phase to 180
    //Calculate new frequency
    if (closeLoop==1) {
      T=(time-hall1tOld)*2; //Half a cycle
    }
    hall1tOld=time;
    phaseRotor=180*phaseConst;
    hallUpdate=1;
    hallUpdateFall=1;
    hallUpdateRise=0;
    PORTC_OFF( PINC2 )
  }
  int phaseU;
  int phaseExcess;
  if (hallUpdate==1) {
    Ttemp=0;
    //PI controllers over phaseAdvance and Voltage
    //Controlling with phaseAdvance. Can not control with amplitud because it can not go negative (It probably can but is not that intuitive)
    //Voltage proportionally "attached" to phaseAdvance.
    //When voltage is maximum, phaseAdvance is 90 and the desired speed is over the maximum with this configuration
    //It allows phaseAdvance to be bigger than 90 (max 180) to allow get the max speed possible
    
    #define Pkp 3 //8-12 works fine for a look of 2Khz, 3 for a loop of 8KHz
    #define PkpHighAdvance 1 // For Advances bigger than 90 degrees. 1 works ok for a look of ~8KHz
    //#define Pki 1 //1 works fine
    static short int Pki=1;
    #define Pkc 1 //1 works fine
    if (closeLoop==1) {
      Terror=-(dT-T);
        phaseU=Terror*Pkp+phaseSum;
        if ((A<maxA) || ((dT<23*4) && (T>28*4)) || (dT>24*4)) {
          Pki=1;
          if (phaseU>maxPhaseAdvance) {
            phaseAdvance=maxPhaseAdvance;
            A=maxA;
          } else {
            if (phaseU<-maxPhaseAdvance) {
              phaseAdvance=-maxPhaseAdvance;
              A=maxA;
            } else {
                phaseAdvance=phaseU;
                //Amplitud proportional to phaseAdvance
                if (phaseAdvance<0) {
                  A=-phaseAdvance/72;
                } else {
                  A=phaseAdvance/72;
                }
            }
          }
        } else {
          Pki=8;
          A=maxA;
          if (phaseU>maxPhaseAdvance*2) {
            phaseAdvance=maxPhaseAdvance*2;
          } else {
            if (phaseU<-maxPhaseAdvance*2) {
              phaseAdvance=-maxPhaseAdvance*2;
            } else {
                //phaseU=Terror*PkpHighAdvance+phaseSum;
                phaseAdvance=phaseU;
            }
          }
        }
      phaseExcess=phaseU-phaseAdvance;
      phaseSum+=Terror/Pki-Pkc*phaseExcess;

      if (A>maxA) {
          A=maxA;
      }
    }
  }
  hall1Old=hall1;

  //update phaseStator
  if (closeLoop==1) {
      phaseStator=phaseRotor+phaseAdvance;
  } else {
    phaseRotor=phaseStator;
  }
  
  //Mantain this numbers controlled
  while (phaseStator>=360*phaseConst) {
    phaseStator=phaseStator-360*phaseConst;
    phaseRotor=phaseRotor-360*phaseConst;
  }
  
  //Get addressing for the sin table
  phaseStatorPointerA=phaseStator/4;
  while (phaseStatorPointerA<0) {
    phaseStatorPointerA=phaseStatorPointerA+sinTableSize;
  }
  phaseStatorPointerB=phaseStatorPointerA-120*10;
  if (phaseStatorPointerB<0) {
    phaseStatorPointerB=phaseStatorPointerB+sinTableSize;
  }
  phaseStatorPointerC=phaseStatorPointerB-120*10;
  if (phaseStatorPointerC<0) {
    phaseStatorPointerC=phaseStatorPointerC+sinTableSize;
  }
  int angleSinA_i=pgm_read_word(sin_table+phaseStatorPointerA);
  int angleSinB_i=pgm_read_word(sin_table+phaseStatorPointerB);
  int angleSinC_i=pgm_read_word(sin_table+phaseStatorPointerC);
  
  PORTC_ON( PINC1 )
  dutyAT=(A*angleSinA_i)/50;
  dutyBT=(A*angleSinB_i)/50;
  dutyCT=(A*angleSinC_i)/50;
  PORTC_OFF( PINC1 )
/*  dutyA=(int) ((A*((signed long int) (angleSinA_i))/(maxA*TimerResFactor)));
  dutyB=(int) ((A*((signed long int) (angleSinB_i))/(maxA*TimerResFactor)));
  dutyC=(int) ((A*((signed long int) (angleSinC_i))/(maxA*TimerResFactor)));*/
//  dutyA=A*maxValPWM*sin((2*M_PI/(360*phaseConst))*((double) phaseStator));
//  dutyB=A*maxValPWM*sin((2*M_PI/(360*phaseConst))*((double) phaseStator)-2.0*M_PI/3.0);
//  dutyC=A*maxValPWM*sin((2*M_PI/(360*phaseConst))*((double) phaseStator)-4.0*M_PI/3.0);
  
  cli();
  dutyA=dutyAT;
  dutyB=dutyBT;
  dutyC=dutyCT;
  sei();
  
  PORTC_OFF( PINC0 )
  
}

ISR(SIG_OVERFLOW1) {
  
  if (dutyA<0) {
    OCR1A=0;
    OCR3A=-dutyA;
  } else {
    OCR1A = dutyA;
    OCR3A =0;    
  }
  if (dutyB<0) {
    OCR1B=0;
    OCR3B=-dutyB;
  } else {
    OCR1B = dutyB;
    OCR3B = 0;
  }
  if (dutyC<0) {
    OCR1C=0;
    OCR3C=-dutyC;
  } else {
    OCR1C = dutyC;
    OCR3C = 0;
  }
  
}


void delayms(uint16_t millis) {
  //uint16_t loop;
  while ( millis ) {
    _delay_ms(1);
    millis--;
  }
}

int main(void) {
  //int i;
  FILE *u0;
  double error;
  double dfreq=0;
  double tfreq;
  double P=0.1;
  int spinning=0;
  
  InitHardware();
  
#if defined( __AVR_LIBC_VERSION__ )
  u0 = fdevopen( UART0_PutCharStdio, UART0_GetCharStdio );
#else  
  u0 = fdevopen( UART0_PutCharStdio, UART0_GetCharStdio, 0 );
#endif
  OCR1A = 0x00;
  OCR1B = 0;
  OCR1C = 0;
  OCR3A = 0;
  OCR3B= 0 ;
  OCR3C=0;
  timer13Start();
  ADCSR |= (1 << ADFR);
  ADMUX |= (1 << ADLAR);
  ADCSR |= (1 << ADSC);
  ADMUX |= (1 << MUX4);
  //ADCSR=0xC7;
  //ADCSR=0xE7;
  //ADMUX=0x00;
  
  //DDRC|= (1 << DDC0);
  //DDRC|= (1 << DDC1);
  DDRC=0xFF;
  PORTC_OFF( PINC0 )
  TIMSK = TIMSK | (1<<TOIE1) | (1<<OCIE2); //Enabling interrupts
  
  while(1) {
    LED_ON( BLUE );
    LED_OFF( RED );
    //printf("Led Blue On \n");
    delayms(5);
    LED_OFF( BLUE );
    LED_ON( RED );
    //printf("Led Blue OFF \n");
    //TCNT1=0;
    /*
    printf("Timer value: %04x ", TCNT1);
    printf("Duty Cycle: %d \n", dutyA);
    printf("ADC0 input: %d\n", (int) ADC);
    */
    //printf("ADCSR: %04x \n", ADCSR);
    //printf("Control Registers 1: %02x 2: %02x 3: %02x\n", TCCR1A, TCCR1B, TCCR1C);
    //printf("XVID crystal divider %02x\n",XDIV);
    
    
    
    /*for ( i = 0; i < 100; i++ ) 
    {
      WaitForTimer0Rollover();
    }*/
    
     
    if ( UART0_IsCharAvailable() )
    {
                char    ch = getchar();

                //printf( "Read: '%c'\n", ch );

                if ( ch == ' ' )
                {
                    /*
                    printf( "*** Set the new frequency\n" );
                    //ch = getchar();
                    int rfreq;
                    scanf("%d",&rfreq);
                    printf( "*** Received %d. Continuing...\n",rfreq );
                    if (rfreq==0) {
                      freq=0;
                      printf( "*** Set the phase\n");
                      int rphase;
                      scanf("%d",&rphase);
                      printf( "*** Received %d. Continuing...\n",rphase);
                      dphase=rphase*2*M_PI/360;
                    }
                    //dfreq=rfreq;
                    A=((double) rfreq)/100;
                    //freq=dfreq;
                    //A=freq/maxFreq;
                    //printf("Setting Amplitud to: %d \n",(int) (100*A));
                    */
                    /*
                    printf( "*** Set the new Amplitud\n" );
                    //ch = getchar();
                    int rA;
                    scanf("%d",&rA);
                    printf( "*** Set the new Phase advance\n" );
                    //ch = getchar();
                    int rPhaseAdvance;
                    scanf("%d",&rPhaseAdvance);
                    printf( "*** Received %d %d. Continuing...\n",rA, rPhaseAdvance );
                    //dfreq=rfreq;
                    A=maxValPWM*((unsigned int) rA)/100;
                    phaseAdvance=rPhaseAdvance*phaseConst;
                    //freq=dfreq;
                    //A=freq/maxFreq;
                    //printf("Setting Amplitud to: %d \n",(int) (100*A));
                    */
                    
                    //printf( "*** Set the new frequency\n" );
                    //ch = getchar();
                    int rfreq;
                    scanf("%d",&rfreq);
                    //printf( "*** Received %d. Continuing...\n",rfreq );
                    dT=(int) ((1.0/((double) (rfreq)))/((double) (Tc)));
                    
                    //printf("Setting Amplitud to: %d \n",(int) (100*A));
                }
    }
    if (closeLoop==0) {
      //printf("Open Loop!\n");
      closeLoop=0;
      spinning=0;
      A=maxA-(maxA/8); //80%
      dfreq=20;
      P=0.2;
      error=dfreq-freq;
      if (error>8.0) {
        error=8.0;
      }
      if (error<-8.0) {
        error=-8.0;
      }
      tfreq=freq+P*error;
      freq=tfreq;
      T=1/(freq*Tc);
      //printf("Period: %d\n", T);
      if (freq>10) {
        //A=maxValPWM;
        //phaseAdvance=90*phaseConst;
        phaseSum=90*phaseConst;
        dT=(int) ((1.0/closeInitFreq)/((double) (Tc))); //50Hz initial freq
        closeLoop=1;
        spinning=1;
      }
    } else {
      if (spinning==1) {
        dfreq=(int) (1/(((double) dT)*Tc));
        freq=(int) (1/(((double) T)*Tc));
        
        if (((dfreq-freq)<fspinError) && ((dfreq-freq)>-fspinError) ) {
          //We have got to the Close loop initial frequency, now going to the final freq
          dT=(int) ((1.0/closeFinalFreq)/((double) (Tc))); //50Hz initial freq
          spinning=0;
        }
      }
      //printf("Close loop!\n");
      if ((1/(T*Tc)<1) && (1/(T*Tc)>-1)) {
        closeLoop=0;
        freq=1/(T*Tc);
      }
    }
    //A=tfreq/maxFreq;
    //if (A<0.6) {
    //  A=0.6;
    //}
    //if (freq>maxFreq) {
    //  A=1.0;
    //}
    int pphaseStator=phaseStator;
    int pphaseRotor=phaseRotor;
    int pTerror=Terror;
    int pdT=dT;
    int pT=T;
    int pphaseAdvance=phaseAdvance;
    int pA=A;
    
    printf("Set_Speed: %d Speed: %d Terror: %d phaseAdvance: %d Amplitud: %d Stator_phase: %d Rotor_phase: %d\n", (int) (10/(((double) pdT)*Tc)) ,(int) (10/(((double ) pT)*Tc)), pTerror, pphaseAdvance/40, pA, pphaseStator/40, pphaseRotor/40);
/*    printf("Frequency: %d , Dest Freq: %d \n",(int) (1/(((double ) T)*Tc)), (int) (1/(((double) dT)*Tc)));
    printf("Phase Stator: %d Phase Rotor: %d\n", pphaseStator, pphaseRotor);
    printf("Period (in ticks) : %d Destination Period(in ticks): %d\n", T, dT );
    printf("Terror: %d phaseAdvance: %d Amplitud: %d\n", pTerror, phaseAdvance/phaseConst, A/36);
    static int pruebaPointer=0;
    printf("Test flash mem: %d\n", pgm_read_word(sin_table+pruebaPointer));
    pruebaPointer+=1;
    if (pruebaPointer==sinTableSize) {
      pruebaPointer=0;
    }*/
/*    int  pphaseStatorPointerA;
    pphaseStatorPointerA=phaseStatorPointerA;
    double pA=A;
    int ppptemp=pgm_read_word(sin_table+pphaseStatorPointerA);
    double pppDoubletemp=pgm_read_word(sin_table+pphaseStatorPointerA);
    
    printf("PhaseStator Pointer: %d, Sin %d, PWM: %d\n", pphaseStatorPointerA, pgm_read_word(sin_table+pphaseStatorPointerA), ((int) (pA*((double) (ppptemp)))) );
*/  //  printf("========================================\n");
    //delayms(500);
  }
  return 0;
}
